use std::io::Cursor;

use crate::parser::nfsv3::procedures::{
    access, commit, create, fsinfo, fsstat, get_attr, link, lookup, mkdir, mknod, pathconf, read,
    readdir, readdir_plus, readlink, remove, rename, rmdir, set_attr, symlink, AccessArgs,
    CommitArgs, CreateArgs, FsInfoArgs, FsStatArgs, GetAttrArgs, LinkArgs, LookUpArgs, MkDirArgs,
    MkNodArgs, PathConfArgs, ReadArgs, ReadDirArgs, ReadDirPlusArgs, ReadLinkArgs, RemoveArgs,
    RenameArgs, RmDirArgs, SetAttrArgs, SymLinkArgs,
};
use crate::parser::nfsv3::DirOpArg;
use crate::parser::Error;
use crate::vfs::{
    AccessMask, CookieVerifier, CreateMode, DirectoryCookie, FileHandle, FileName, FileTime,
    FsPath, SetAttr, SetAttrGuard, SetTime, SpecialNode,
};

#[test]
fn test_access() {
    let mut data = Cursor::new(vec![
        0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x00, 0x00, 0x00,
        0x1F,
    ]);

    let result = access(&mut data).unwrap();
    let expected = AccessArgs {
        object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]),
        access: AccessMask(0x1F),
    };
    assert_eq!(result, expected);
}

#[test]
fn test_get_attr() {
    let mut data =
        Cursor::new(vec![0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]);

    let result = get_attr(&mut data).unwrap();
    let expected =
        GetAttrArgs { object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]) };
    assert_eq!(result, expected);
}

#[test]
fn test_set_attr() {
    let mut data = Cursor::new(vec![
        0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x00, 0x00, 0x00,
        0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
        0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
        0x00,
    ]);

    let result = set_attr(&mut data).unwrap();
    let expected = SetAttrArgs {
        object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]),
        new_attribute: SetAttr {
            mode: Some(256),
            uid: Some(1),
            gid: Some(2),
            size: Some(16),
            atime: SetTime::ClientProvided(FileTime { seconds: 1, nanos: 0 }),
            mtime: SetTime::ServerCurrent,
        },
        guard: SetAttrGuard::Check { ctime: FileTime { seconds: 2, nanos: 0 } },
    };
    assert_eq!(result, expected);
}

#[test]
fn test_lookup() {
    let mut data = Cursor::new(vec![
        0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x00, 0x00, 0x00,
        0x04, b't', b'e', b's', b't',
    ]);

    let result = lookup(&mut data).unwrap();
    let expected = LookUpArgs {
        object: DirOpArg {
            object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]),
            name: FileName(String::from("test")),
        },
    };
    assert_eq!(result, expected);
}

#[test]
fn test_readlink() {
    let mut data =
        Cursor::new(vec![0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]);

    let result = readlink(&mut data).unwrap();
    let expected =
        ReadLinkArgs { object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]) };
    assert_eq!(result, expected);
}

#[test]
fn test_read() {
    let mut data = Cursor::new(vec![
        0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00,
    ]);

    let result = read(&mut data).unwrap();
    let expected = ReadArgs {
        object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]),
        offset: 65536,
        count: 1024,
    };
    assert_eq!(result, expected);
}

#[test]
fn test_create() {
    let mut data = Cursor::new(vec![
        0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x00, 0x00, 0x00,
        0x04, b'f', b'i', b'l', b'e', 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    ]);

    let result = create(&mut data).unwrap();
    let expected = CreateArgs {
        object: DirOpArg {
            object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]),
            name: FileName(String::from("file")),
        },
        mode: CreateMode::Unchecked {
            attr: SetAttr {
                mode: None,
                uid: None,
                gid: None,
                size: None,
                atime: SetTime::DontChange,
                mtime: SetTime::DontChange,
            },
        },
    };
    assert_eq!(result, expected);
}

#[test]
fn test_mkdir() {
    let mut data = Cursor::new(vec![
        0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x00, 0x00, 0x00,
        0x04, b'd', b'i', b'r', b'1', 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x25, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
        0x00, 0x00, 0x01,
    ]);

    let result = mkdir(&mut data).unwrap();

    let expected = MkDirArgs {
        object: DirOpArg {
            object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]),
            name: FileName(String::from("dir1")),
        },
        attr: SetAttr {
            mode: Some(37),
            uid: None,
            gid: None,
            size: None,
            atime: SetTime::ServerCurrent,
            mtime: SetTime::ServerCurrent,
        },
    };
    assert_eq!(result, expected);
}

#[test]
fn test_symlink() {
    let mut data = Cursor::new(vec![
        0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x00, 0x00, 0x00,
        0x04, b'l', b'i', b'n', b'k', 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0xA4, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, b'/', b'p', b'a', b't', b'h', b'/', 0x00, 0x00,
    ]);

    let result = symlink(&mut data).unwrap();
    let expected = SymLinkArgs {
        object: DirOpArg {
            object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]),
            name: FileName(String::from("link")),
        },
        attr: SetAttr {
            mode: Some(0o644),
            uid: None,
            gid: None,
            size: None,
            atime: SetTime::DontChange,
            mtime: SetTime::DontChange,
        },
        path: FsPath(String::from("/path/")),
    };
    assert_eq!(result, expected);
}

#[test]
fn test_mknod_regular() {
    let mut data = Cursor::new(vec![
        0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x00, 0x00, 0x00,
        0x04, b'n', b'o', b'd', b'e', 0x00, 0x00, 0x00, 0x01,
    ]);

    let result = mknod(&mut data).unwrap();
    let expected = MkNodArgs {
        object: DirOpArg {
            object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]),
            name: FileName(String::from("node")),
        },
        mode: SpecialNode::Regular,
    };
    assert_eq!(result, expected);
}

#[test]
fn test_remove() {
    let mut data = Cursor::new(vec![
        0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x00, 0x00, 0x00,
        0x04, b'f', b'i', b'l', b'e',
    ]);

    let result = remove(&mut data).unwrap();
    let expected = RemoveArgs {
        object: DirOpArg {
            object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]),
            name: FileName(String::from("file")),
        },
    };
    assert_eq!(result, expected);
}

#[test]
fn test_rmdir() {
    let mut data = Cursor::new(vec![
        0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x00, 0x00, 0x00,
        0x04, b'd', b'i', b'r', b'1',
    ]);

    let result = rmdir(&mut data).unwrap();
    let expected = RmDirArgs {
        object: DirOpArg {
            object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]),
            name: FileName(String::from("dir1")),
        },
    };
    assert_eq!(result, expected);
}

#[test]
fn test_rename() {
    let mut data = Cursor::new(vec![
        0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x00, 0x00, 0x00,
        0x04, b'o', b'l', b'd', b'n', 0x00, 0x00, 0x00, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E,
        0x0F, 0x10, 0x00, 0x00, 0x00, 0x04, b'n', b'e', b'w', b'n',
    ]);

    let result = rename(&mut data).unwrap();
    let expected = RenameArgs {
        from: DirOpArg {
            object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]),
            name: FileName(String::from("oldn")),
        },
        to: DirOpArg {
            object: FileHandle([0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x10]),
            name: FileName(String::from("newn")),
        },
    };
    assert_eq!(result, expected);
}

#[test]
fn test_link() {
    let mut data = Cursor::new(vec![
        0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x00, 0x00, 0x00,
        0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x10, 0x00, 0x00, 0x00, 0x04, b'l', b'i',
        b'n', b'k',
    ]);

    let result = link(&mut data).unwrap();
    let expected = LinkArgs {
        object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]),
        link: DirOpArg {
            object: FileHandle([0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x10]),
            name: FileName(String::from("link")),
        },
    };
    assert_eq!(result, expected);
}

#[test]
fn test_readdir() {
    let mut data = Cursor::new(vec![
        0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00,
        0x08, 0x00,
    ]);

    let result = readdir(&mut data).unwrap();
    let expected = ReadDirArgs {
        object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]),
        cookie: DirectoryCookie(4096),
        verf: CookieVerifier(8192),
        count: 2048,
    };
    assert_eq!(result, expected);
}

#[test]
fn test_readdir_plus() {
    let mut data = Cursor::new(vec![
        0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00,
        0x08, 0x00, 0x00, 0x00, 0x10, 0x00,
    ]);

    let result = readdir_plus(&mut data).unwrap();
    let expected = ReadDirPlusArgs {
        object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]),
        cookie: DirectoryCookie(4096),
        verf: CookieVerifier(8192),
        count: 2048,
        max_count: 4096,
    };
    assert_eq!(result, expected);
}

#[test]
fn test_fsstat() {
    let mut data =
        Cursor::new(vec![0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]);

    let result = fsstat(&mut data).unwrap();
    let expected =
        FsStatArgs { object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]) };
    assert_eq!(result, expected);
}

#[test]
fn test_fsinfo() {
    let mut data =
        Cursor::new(vec![0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]);

    let result = fsinfo(&mut data).unwrap();
    let expected =
        FsInfoArgs { object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]) };
    assert_eq!(result, expected);
}

#[test]
fn test_pathconf() {
    let mut data =
        Cursor::new(vec![0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]);

    let result = pathconf(&mut data).unwrap();
    let expected =
        PathConfArgs { object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]) };
    assert_eq!(result, expected);
}

#[test]
fn test_commit() {
    let mut data = Cursor::new(vec![
        0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00,
    ]);

    let result = commit(&mut data).unwrap();
    let expected = CommitArgs {
        object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]),
        offset: 65536,
        count: 1024,
    };
    assert_eq!(result, expected);
}

#[test]
fn test_read_insufficient_data() {
    let mut data =
        Cursor::new(vec![0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07]);

    let result = read(&mut data);
    assert!(matches!(result, Err(Error::IO(_))));
}

#[test]
fn test_set_attr_insufficient_data() {
    let mut data = Cursor::new(vec![
        0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x00, 0x00, 0x00,
        0x01, 0x00, 0x00, 0x01, 0xA4,
    ]);

    let result = set_attr(&mut data);
    assert!(matches!(result, Err(Error::IO(_))));
}

#[test]
fn test_lookup_unaligned_name() {
    let mut data = Cursor::new(vec![
        0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x00, 0x00, 0x00,
        0x03, b'a', b'b', b'c',
    ]);

    let result = lookup(&mut data);
    assert!(result.is_err());
}

#[test]
fn test_create_unaligned_after_name() {
    let mut data = Cursor::new(vec![
        0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x00, 0x00, 0x00,
        0x02, b'a', b'b', 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x02,
    ]);

    let result = create(&mut data);
    assert!(result.is_err());
}

#[test]
fn test_symlink_unaligned_path() {
    let mut data = Cursor::new(vec![
        0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x00, 0x00, 0x00,
        0x03, b'l', b'i', b'n', 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0xA4, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0xA4, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x05, b'/', b'p', b'a', b't', b'h',
    ]);

    let result = symlink(&mut data);
    assert!(result.is_err());
}

#[test]
fn test_readdir_unaligned_after_fh() {
    let mut data = Cursor::new(vec![
        0x00, 0x00, 0x00, 0x07, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x08,
        0x00,
    ]);

    let result = readdir(&mut data);
    assert!(result.is_err());
}
