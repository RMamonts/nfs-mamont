use crate::parser::nfsv3::procedures::FsStatArgs;
use crate::parser::parser_struct::RpcParser;
use crate::parser::tests::allocator::MockAllocator;
use crate::parser::tests::socket::MockSocket;
use crate::parser::{Arguments, Error};
use crate::vfs::FileHandle;

#[tokio::test]
async fn parse_two_correct() {
    let buf = vec![
        0x80, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x02, 0x00, 0x01, 0x86, 0xA3, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x12, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05,
        0x06, 0x07, 0x08, 0x80, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x02, 0x00, 0x01, 0x86, 0xA3, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
        0x12, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x01, 0x02,
        0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
    ];
    let socket = MockSocket::new(buf.as_slice());
    let alloc = MockAllocator::new(0);
    let mut parser = RpcParser::new(socket, alloc, 80);
    let expected =
        FsStatArgs { object: FileHandle([0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08]) };
    let result1 = parser.parse_message().await;
    match *result1.unwrap() {
        Arguments::FsStat(args) => {
            assert_eq!(args, expected);
        }
        _ => panic!("Wrong result type"),
    }
    let result2 = parser.parse_message().await.unwrap();

    match *result2 {
        Arguments::FsStat(args) => {
            assert_eq!(args, expected);
        }
        _ => panic!("Wrong result type"),
    }
}

#[tokio::test]
async fn parse_write_without_async() {
    let buf = vec![
        0x80, 0x00, 0x00, 72, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x02, 0x00, 0x01, 0x86, 0xA3, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05,
        0x06, 0x07, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x02, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x11, 0x22, 0x33, 0x44,
    ];

    let socket = MockSocket::new(buf.as_slice());
    let alloc = MockAllocator::new(4);
    let mut parser = RpcParser::new(socket, alloc, 80);
    let result2 = parser.parse_message().await.unwrap();

    match *result2 {
        Arguments::Write(_) => {}
        _ => panic!("Wrong result type"),
    }
}

#[tokio::test]
async fn parse_write_with_async() {
    let buf = vec![
        0x80, 0x00, 0x00, 74, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x02, 0x00, 0x01, 0x86, 0xA3, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05,
        0x06, 0x07, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x02, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x11, 0x22, 0x33, 0x44, 0x01, 0x00, 0x00,
        0x00,
    ];

    let socket = MockSocket::new(buf.as_slice());
    let alloc = MockAllocator::new(6);
    let mut parser = RpcParser::new(socket, alloc, 68);
    let result2 = parser.parse_message().await.unwrap();

    match *result2 {
        Arguments::Write(_) => {}
        _ => panic!("Wrong result type"),
    }
}

#[tokio::test]
async fn program_mismatch() {
    let buf = vec![
        0x80, 0x00, 0x00, 74, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x02, 0x00, 0x01, 0x86, 0xA3, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x01, 0x02, 0x03, 0x04, 0x05,
        0x06, 0x07, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x02, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x11, 0x22, 0x33, 0x44, 0x01, 0x00, 0x00,
        0x00,
    ];

    let socket = MockSocket::new(buf.as_slice());
    let alloc = MockAllocator::new(6);
    let mut parser = RpcParser::new(socket, alloc, 68);
    let result2 = parser.parse_message().await;
    assert!(matches!(result2, Err(Error::ProcedureMismatch)))
}
